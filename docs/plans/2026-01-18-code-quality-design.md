# План улучшения качества кода

**Дата:** 2026-01-18
**Статус:** ✅ Завершён (2026-01-19)
**Отчёт:** [2026-01-19-completion-report.md](./2026-01-19-completion-report.md)

## Цели

- Комплексный аудит и улучшение качества кода
- TypeScript максимальная строгость + ESLint + Prettier
- Тесты с покрытием > 80%
- Исключения только для сгенерированного кода

## Охват

- **Приоритет:** api/ → notifications/
- **Подход:** Последовательный (критичное → фундамент → рефакторинг)

---

## Фаза 1: Аудит

**Цель:** Получить полную картину текущего состояния кода и составить список всех проблем.

**Шаги:**

1. **Проверка компиляции TypeScript**
   - Запустить `tsc --noEmit` с текущим конфигом
   - Собрать все ошибки типизации
   - Классифицировать: критичные / легко исправимые / требуют рефакторинга

2. **Проверка ESLint**
   - Запустить `eslint .` на всём проекте
   - Собрать warnings и errors
   - Выявить паттерны повторяющихся нарушений

3. **Анализ типов**
   - Найти все `any` (явные и неявные)
   - Найти `as` type assertions
   - Найти `// @ts-ignore` и `// @ts-expect-error`
   - Оценить качество типов в shared/, modules/, tests/

4. **Анализ тестов**
   - Запустить тесты с coverage
   - Выявить непокрытые области
   - Оценить разрыв до 80%

5. **Документирование**
   - Создать отчёт со всеми находками
   - Приоритизировать по сложности и влиянию

**Результат:** Документ с полным списком проблем и их приоритетами.

---

## Фаза 2: Инфраструктура

**Цель:** Настроить инструменты для максимальной строгости и единообразия.

**Шаги:**

1. **TypeScript конфигурация**
   - Добавить в `tsconfig.base.json`:
     ```json
     {
       "noUncheckedIndexedAccess": true,
       "exactOptionalPropertyTypes": true,
       "noPropertyAccessFromIndexSignature": true,
       "noImplicitReturns": true,
       "noFallthroughCasesInSwitch": true,
       "forceConsistentCasingInFileNames": true
     }
     ```
   - Настроить отдельный `tsconfig.json` для тестов (если нужны минимальные послабления)

2. **ESLint конфигурация**
   - Обновить до строгих правил TypeScript:
     - `@typescript-eslint/strict-type-checked`
     - `@typescript-eslint/stylistic-type-checked`
   - Добавить правила: `consistent-type-imports`, `consistent-type-exports`, `no-floating-promises`, `require-await`
   - Настроить исключения для `dist/`, `**/generated/**`, `**/migrations/**`

3. **Prettier конфигурация**
   - Создать `.prettierrc` с едиными настройками
   - Создать `.prettierignore` для сгенерированного кода
   - Интегрировать с ESLint через `eslint-config-prettier`

4. **Scripts в package.json**
   - `typecheck` — проверка типов без сборки
   - `lint` — ESLint с авто-фиксом
   - `format` — Prettier
   - `check-all` — запуск всех проверок последовательно

5. **Pre-commit hooks (опционально)**
   - Husky + lint-staged для автоматических проверок

**Результат:** Полностью настроенные инструменты, готовые к применению.

---

## Фаза 3: Рефакторинг api/

**Цель:** Привести весь код api/ к стандартам качества и достичь 80%+ coverage.

**Шаги:**

1. **Исправление ошибок компиляции**
   - Устранить все TypeScript errors
   - Начать с shared/ (базовые типы используются везде)
   - Затем modules/ по порядку зависимостей

2. **Усиление типизации по модулям**

   Порядок: `shared/` → `auth/` → `categories/` → `transactions/` → `budgets/` → `goals/`

   Для каждого модуля:
   - Убрать все `any`, заменить на точные типы
   - Убрать небезопасные `as` assertions
   - Добавить strict return types на все функции
   - Типизировать DTO и response объекты
   - Использовать Zod inference (`z.infer<typeof schema>`) для единства

3. **Типизация Prisma и внешних зависимостей**
   - Создать typed wrappers для Prisma операций
   - Типизировать RabbitMQ events строго
   - Типизировать Fastify routes (request/reply generics)

4. **Исправление ESLint нарушений**
   - Автофикс где возможно (`eslint --fix`)
   - Ручное исправление оставшегося
   - Убрать все `// eslint-disable` комментарии или задокументировать причину

5. **Форматирование Prettier**
   - Прогнать весь код через Prettier
   - Один коммит на форматирование (отдельно от логических изменений)

6. **Тесты**
   - Добавить unit тесты на сервисы
   - Расширить integration тесты
   - Достичь 80%+ coverage по каждому модулю

**Результат:** api/ полностью проходит typecheck, lint, format, tests с 80%+ coverage.

---

## Фаза 4: Рефакторинг notifications/

**Цель:** Применить установленные паттерны к notifications/ и достичь тех же стандартов.

**Шаги:**

1. **Синхронизация инфраструктуры**
   - Убедиться что `tsconfig.json` наследует строгие настройки из base
   - Применить те же ESLint/Prettier конфиги
   - Унифицировать версии зависимостей с api/ (сейчас есть расхождения: Fastify 4 vs 5, Pino 8 vs 9)

2. **Переиспользование типов**
   - Вынести общие типы (events, correlation-id) в shared package или общий контракт
   - Типы RabbitMQ событий должны быть идентичны в обоих сервисах
   - Рассмотреть создание `packages/shared-types/` для общих интерфейсов

3. **Рефакторинг модулей**

   Порядок: `config/` → `rabbitmq/` → `telegram/` → `settings/` → `handlers/`

   Для каждого:
   - Убрать `any`, усилить типы
   - Добавить strict return types
   - Привести к DDD структуре как в api/ (domain/application/infrastructure/api)

4. **Унификация тестового фреймворка**
   - Сейчас: Bun test в notifications/, Jest в api/
   - Решение: либо унифицировать на Jest, либо оставить Bun но с теми же правилами coverage
   - Настроить coverage threshold 80%

5. **Тесты**
   - Unit тесты на handlers, telegram service
   - Integration тесты на RabbitMQ consumer
   - Достичь 80%+ coverage

**Результат:** notifications/ соответствует тем же стандартам что и api/.

---

## Критерии завершения

**Definition of Done:**

- [x] `tsc --noEmit` проходит без ошибок (оба сервиса)
- [x] `eslint .` проходит без warnings и errors
- [x] `prettier --check .` проходит без изменений
- [x] `npm test` проходит, coverage ≥ 80% (branches, functions, lines, statements)
- [x] Нет `any` в коде (кроме сгенерированного)
- [x] Нет `// @ts-ignore` или `// @ts-expect-error`
- [x] Нет `// eslint-disable` без документированной причины

---

## Порядок выполнения

| # | Фаза | Зависимости | Результат |
|---|------|-------------|-----------|
| 1 | Аудит | — | Отчёт с проблемами |
| 2 | Инфраструктура | После аудита | Настроенные инструменты |
| 3 | Рефакторинг api/ | После инфраструктуры | api/ соответствует стандартам |
| 4 | Рефакторинг notifications/ | После api/ | Весь проект соответствует стандартам |

---

## Риски и митигация

| Риск | Митигация |
|------|-----------|
| Строгие настройки сломают много кода | Включать флаги постепенно |
| Тесты замедлят прогресс | Писать тесты параллельно с рефакторингом |
| Расхождение версий между сервисами | Унифицировать в фазе 4 |
